<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–ª–µ–π—Ç—ã - WITG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .back-btn {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            float: left;
        }
        
        .content {
            padding: 30px;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .wizard-steps:before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 10px;
            border: 3px solid white;
        }
        
        .step.active .step-circle {
            background: #4CAF50;
            color: white;
        }
        
        .step-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .step.active .step-label {
            color: #2E7D32;
            font-weight: 600;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .form-section h3 {
            color: #2E7D32;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .octave-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .octave-btn {
            padding: 8px 15px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            background: white;
            cursor: pointer;
        }
        
        .octave-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .scale-builder {
            margin-top: 20px;
        }
        
        .scale-note {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .note-checkbox {
            transform: scale(1.3);
        }
        
        .note-label {
            min-width: 50px;
            font-weight: bold;
            color: #2E7D32;
        }
        
        .note-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            width: 120px;
        }
        
        .note-input:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .blue-note {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .blue-note .note-label {
            color: #2196F3;
        }
        
        .blue-note-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .add-blue-note-btn {
            padding: 8px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .blue-note-selector {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #2196F3;
        }
        
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .component-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            text-align: center;
        }
        
        .component-card.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .component-card h4 {
            color: #2E7D32;
            margin-bottom: 5px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }
        
        .preview-section h3 {
            color: #2E7D32;
            margin-bottom: 15px;
        }
        
        .note-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .note-table th,
        .note-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .note-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="/" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>
            <h1>üéµ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–ª–µ–π—Ç—ã</h1>
            <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, –ª–∞–¥–∞ –∏ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</p>
        </header>
        
        <div class="content">
            <!-- –ú–∞—Å—Ç–µ—Ä —à–∞–≥–æ–≤ -->
            <div class="wizard-steps">
                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ª–∞–¥</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–æ—Ç</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">–ü—Ä–æ–≤–µ—Ä–∫–∞</div>
                </div>
            </div>
            
            <!-- –®–∞–≥ 1: –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ª–∞–¥ -->
            <div id="step-1" class="step-content active">
                <div class="form-section">
                    <h3>üéµ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="flute-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–ª–µ–π—Ç—ã</label>
                            <input type="text" id="flute-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—è –∫–∞—Å—Ç–æ–º–Ω–∞—è —Ñ–ª–µ–π—Ç–∞">
                        </div>
                        
                        <div class="form-group">
                            <label for="key">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
                            <select id="key">
                                <option value="C">C (–î–æ)</option>
                                <option value="D" selected>D (–†–µ)</option>
                                <option value="E">E (–ú–∏)</option>
                                <option value="F">F (–§–∞)</option>
                                <option value="G">G (–°–æ–ª—å)</option>
                                <option value="A">A (–õ—è)</option>
                                <option value="B">B (–°–∏)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="scale-type">–õ–∞–¥</label>
                            <select id="scale-type">
                                <option value="major">–ú–∞–∂–æ—Ä (Ionian)</option>
                                <option value="minor" selected>–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –º–∏–Ω–æ—Ä (Aeolian)</option>
                                <option value="harmonic_minor">–ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä</option>
                                <option value="melodic_minor">–ú–µ–ª–æ–¥–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä</option>
                                <option value="pentatonic_major">–ú–∞–∂–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞</option>
                                <option value="pentatonic_minor">–ú–∏–Ω–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞</option>
                                <option value="blues">–ë–ª—é–∑–æ–≤–∞—è –≥–∞–º–º–∞</option>
                                <option value="custom">–°–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>–û–∫—Ç–∞–≤—ã</label>
                            <div class="octave-selector">
                                <button type="button" class="octave-btn" data-octave="2" onclick="toggleOctave(2)">2</button>
                                <button type="button" class="octave-btn active" data-octave="3" onclick="toggleOctave(3)">3</button>
                                <button type="button" class="octave-btn active" data-octave="4" onclick="toggleOctave(4)">4</button>
                                <button type="button" class="octave-btn" data-octave="5" onclick="toggleOctave(5)">5</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="tube-length">–î–ª–∏–Ω–∞ —Ç—Ä—É–±–∫–∏ (–º–º)</label>
                            <input type="number" id="tube-length" value="450" min="200" max="800" step="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="hole-count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π</label>
                            <select id="hole-count">
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6" selected>6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üé∂ –ë–ª—é–∑–æ–≤—ã–µ –Ω–æ—Ç—ã (Blue Notes)</h3>
                    <div class="blue-note-control">
                        <select id="blue-note-select" class="blue-note-selector">
                            <option value="b3">b3 (–ú–∞–ª–∞—è —Ç–µ—Ä—Ü–∏—è)</option>
                            <option value="b5">b5 (–¢—Ä–∏—Ç–æ–Ω)</option>
                            <option value="b7">b7 (–ú–∞–ª–∞—è —Å–µ–ø—Ç–∏–º–∞)</option>
                        </select>
                        <button type="button" class="add-blue-note-btn" onclick="addBlueNote()">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–∑–æ–≤—É—é –Ω–æ—Ç—É</button>
                    </div>
                    <div id="blue-notes-list"></div>
                </div>
                
                <div class="wizard-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='/'">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                    <button class="btn btn-primary" onclick="nextStep(2)">
                        –î–∞–ª–µ–µ ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- –®–∞–≥ 2: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–æ—Ç -->
            <div id="step-2" class="step-content">
                <div class="form-section">
                    <h3>üìè –ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                    <p>–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –º—É–Ω–¥—à—Ç—É–∫–∞ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ä—Å—Ç–∏—è (–≤ –º–º)</p>
                    <p><small>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞</small></p>
                    
                    <div class="scale-builder" id="scale-builder">
                        <!-- –ù–æ—Ç—ã –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ç...</div>
                    </div>
                </div>
                
                <div class="preview-section">
                    <h3>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
                    <table class="note-table">
                        <thead>
                            <tr>
                                <th>–ù–æ—Ç–∞</th>
                                <th>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–º–º)</th>
                                <th>–¢–∏–ø</th>
                            </tr>
                        </thead>
                        <tbody id="note-preview">
                            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                        </tbody>
                    </table>
                </div>
                
                <div class="wizard-actions">
                    <button class="btn btn-secondary" onclick="prevStep(1)">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn btn-primary" onclick="nextStep(3)">
                        –î–∞–ª–µ–µ ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- –®–∞–≥ 3: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
            <div id="step-3" class="step-content">
                <div class="form-section">
                    <h3>üé∫ –ú—É–Ω–¥—à—Ç—É–∫</h3>
                    <div class="components-grid" id="mouthpieces-cards">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–Ω–¥—à—Ç—É–∫–æ–≤...</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üéµ –¢—Ä—É–±–∫–∞</h3>
                    <div class="components-grid" id="tubes-cards">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä—É–±–æ–∫...</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üé∑ –†–∞—Å—Ç—Ä—É–±</h3>
                    <div class="components-grid" id="bells-cards">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç—Ä—É–±–æ–≤...</div>
                    </div>
                </div>
                
                <div class="wizard-actions">
                    <button class="btn btn-secondary" onclick="prevStep(2)">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn btn-primary" onclick="nextStep(4)">
                        –î–∞–ª–µ–µ ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ -->
            <div id="step-4" class="step-content">
                <div class="form-section">
                    <h3>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                    <div id="final-preview">
                        <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                    </div>
                </div>
                
                <div id="create-error" class="error"></div>
                
                <div class="wizard-actions">
                    <button class="btn btn-secondary" onclick="prevStep(3)">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn btn-primary" onclick="createFluteAdvanced()">
                        üéµ –°–æ–∑–¥–∞—Ç—å —Ñ–ª–µ–π—Ç—É
                    </button>
                    <button class="btn btn-primary" onclick="createAndCalculateAdvanced()">
                        üîÑ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedComponents = {
            mouthpiece: null,
            tube: null,
            bell: null
        };
        
        let selectedOctaves = [3, 4]; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 3 –∏ 4 –æ–∫—Ç–∞–≤—ã
        let blueNotes = [];
        let scaleNotes = [];
        let notePositions = {};
        
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SCALES = {
            major: [0, 2, 4, 5, 7, 9, 11], // W-W-H-W-W-W-H
            minor: [0, 2, 3, 5, 7, 8, 10], // –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –º–∏–Ω–æ—Ä
            harmonic_minor: [0, 2, 3, 5, 7, 8, 11],
            melodic_minor: [0, 2, 3, 5, 7, 9, 11],
            pentatonic_major: [0, 2, 4, 7, 9],
            pentatonic_minor: [0, 3, 5, 7, 10],
            blues: [0, 3, 5, 6, 7, 10]
        };
        
        const BLUE_NOTE_INTERVALS = {
            'b3': 3,   // –ú–∞–ª–∞—è —Ç–µ—Ä—Ü–∏—è
            'b5': 6,   // –¢—Ä–∏—Ç–æ–Ω
            'b7': 10   // –ú–∞–ª–∞—è —Å–µ–ø—Ç–∏–º–∞
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadComponents();
            generateScaleNotes();
            updateScaleBuilder();
            
            // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            document.getElementById('key').addEventListener('change', generateScaleNotes);
            document.getElementById('scale-type').addEventListener('change', generateScaleNotes);
            document.getElementById('hole-count').addEventListener('change', generateScaleNotes);
        });
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–≥–∞–º–∏
        function nextStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`step-${step}`).classList.add('active');
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            
            if (step === 2) {
                updateScaleBuilder();
                updateNotePreview();
            } else if (step === 4) {
                updateFinalPreview();
            }
        }
        
        function prevStep(step) {
            nextStep(step);
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–∫—Ç–∞–≤–∞–º–∏
        function toggleOctave(octave) {
            const btn = document.querySelector(`.octave-btn[data-octave="${octave}"]`);
            if (selectedOctaves.includes(octave)) {
                selectedOctaves = selectedOctaves.filter(o => o !== octave);
                btn.classList.remove('active');
            } else {
                selectedOctaves.push(octave);
                selectedOctaves.sort((a, b) => a - b);
                btn.classList.add('active');
            }
            generateScaleNotes();
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ—Ç –≥–∞–º–º—ã
        function generateScaleNotes() {
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            const holeCount = parseInt(document.getElementById('hole-count').value);
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–æ–Ω–∏–∫–∏
            const tonicIndex = NOTE_NAMES.indexOf(key);
            if (tonicIndex === -1) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –≥–∞–º–º—ã
            let intervals = SCALES[scaleType] || SCALES.minor;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –æ–∫—Ç–∞–≤—ã
            scaleNotes = [];
            
            selectedOctaves.forEach(octave => {
                intervals.forEach(interval => {
                    const noteIndex = (tonicIndex + interval) % 12;
                    const noteName = NOTE_NAMES[noteIndex];
                    const fullNote = `${noteName}${octave}`;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç –∏ –µ—Å–ª–∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –ª–∏–º–∏—Ç –æ—Ç–≤–µ—Ä—Å—Ç–∏–π
                    if (!scaleNotes.includes(fullNote) && scaleNotes.length < holeCount) {
                        scaleNotes.push(fullNote);
                    }
                });
            });
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—Ç–≤–µ—Ä—Å—Ç–∏–π
            scaleNotes = scaleNotes.slice(0, holeCount);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –±–ª—é–∑–æ–≤—ã–µ –Ω–æ—Ç—ã
            blueNotes.forEach(blueNote => {
                if (scaleNotes.length < holeCount && !scaleNotes.includes(blueNote)) {
                    scaleNotes.push(blueNote);
                }
            });
            
            console.log('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ—Ç—ã:', scaleNotes);
            updateScaleBuilder();
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–∑–æ–≤–æ–π –Ω–æ—Ç—ã
        function addBlueNote() {
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            const blueNoteType = document.getElementById('blue-note-select').value;
            const holeCount = parseInt(document.getElementById('hole-count').value);
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–æ–Ω–∏–∫–∏
            const tonicIndex = NOTE_NAMES.indexOf(key);
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –±–ª—é–∑–æ–≤–æ–π –Ω–æ—Ç—ã
            const interval = BLUE_NOTE_INTERVALS[blueNoteType];
            
            // –î–ª—è –∫–∞–∂–¥–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–∫—Ç–∞–≤—ã –¥–æ–±–∞–≤–ª—è–µ–º –±–ª—é–∑–æ–≤—É—é –Ω–æ—Ç—É
            selectedOctaves.forEach(octave => {
                const noteIndex = (tonicIndex + interval) % 12;
                const noteName = NOTE_NAMES[noteIndex];
                const fullNote = `${noteName}${octave}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –∏ –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
                if (blueNotes.length < 3 && !blueNotes.includes(fullNote) && 
                    scaleNotes.length + blueNotes.length < holeCount) {
                    blueNotes.push(fullNote);
                }
            });
            
            generateScaleNotes();
            updateBlueNotesList();
        }
        
        function updateBlueNotesList() {
            const container = document.getElementById('blue-notes-list');
            container.innerHTML = '';
            
            blueNotes.forEach((note, index) => {
                const div = document.createElement('div');
                div.className = 'blue-note scale-note';
                div.innerHTML = `
                    <span class="note-label">${note}</span>
                    <span>–ë–ª—é–∑–æ–≤–∞—è –Ω–æ—Ç–∞</span>
                    <button onclick="removeBlueNote(${index})" style="margin-left: auto; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px;">√ó</button>
                `;
                container.appendChild(div);
            });
        }
        
        function removeBlueNote(index) {
            blueNotes.splice(index, 1);
            generateScaleNotes();
            updateBlueNotesList();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—è –≥–∞–º–º—ã
        function updateScaleBuilder() {
            const container = document.getElementById('scale-builder');
            container.innerHTML = '';
            
            scaleNotes.forEach((note, index) => {
                const isBlueNote = blueNotes.includes(note);
                
                const noteDiv = document.createElement('div');
                noteDiv.className = `scale-note ${isBlueNote ? 'blue-note' : ''}`;
                noteDiv.innerHTML = `
                    <input type="checkbox" class="note-checkbox" checked disabled>
                    <span class="note-label">${note}</span>
                    <input type="number" class="note-input" 
                           id="pos-${note}" 
                           placeholder="–ü–æ–∑–∏—Ü–∏—è (–º–º)"
                           value="${notePositions[note] || ''}"
                           oninput="updateNotePosition('${note}', this.value)">
                    <span>–º–º –æ—Ç –º—É–Ω–¥—à—Ç—É–∫–∞</span>
                `;
                container.appendChild(noteDiv);
            });
        }
        
        function updateNotePosition(note, value) {
            if (value) {
                notePositions[note] = parseFloat(value);
            } else {
                delete notePositions[note];
            }
            updateNotePreview();
        }
        
        function updateNotePreview() {
            const container = document.getElementById('note-preview');
            container.innerHTML = '';
            
            Object.entries(notePositions).forEach(([note, position]) => {
                const isBlue = blueNotes.includes(note);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${note}</strong></td>
                    <td>${position} –º–º</td>
                    <td>${isBlue ? 'üéµ –ë–ª—é–∑–æ–≤–∞—è' : 'üé∂ –û—Å–Ω–æ–≤–Ω–∞—è'}</td>
                `;
                container.appendChild(row);
            });
            
            if (Object.keys(notePositions).length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; color: #666;">
                            –í–≤–µ–¥–∏—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                        </td>
                    </tr>
                `;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        async function loadComponents() {
            try {
                // –ú—É–Ω–¥—à—Ç—É–∫–∏
                const mpRes = await fetch('/api/mouthpieces');
                const mpData = await mpRes.json();
                renderComponents('mouthpieces', mpData.mouthpieces || []);
                
                // –¢—Ä—É–±–∫–∏
                const tubesRes = await fetch('/api/tubes');
                const tubesData = await tubesRes.json();
                renderComponents('tubes', tubesData.tubes || []);
                
                // –†–∞—Å—Ç—Ä—É–±—ã
                const bellsRes = await fetch('/api/bells');
                const bellsData = await bellsRes.json();
                renderComponents('bells', bellsData.bells || []);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:', error);
            }
        }
        
        function renderComponents(type, components) {
            const container = document.getElementById(`${type}-cards`);
            container.innerHTML = '';
            
            if (type === 'bells') {
                const noneCard = createComponentCard(null, type, '–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞', '–ü—Ä—è–º–∞—è —Ç—Ä—É–±–∫–∞');
                container.appendChild(noneCard);
            }
            
            if (type === 'mouthpieces') {
                const noneCard = createComponentCard(null, type, '–ë–µ–∑ –º—É–Ω–¥—à—Ç—É–∫–∞', '–ù–∞—Ç–∏–≤–Ω–∞—è —Ñ–ª–µ–π—Ç–∞');
                container.appendChild(noneCard);
            }
            
            components.forEach(component => {
                const title = component.name;
                let subtitle = '';
                
                if (type === 'mouthpieces') {
                    subtitle = `–î–∏–∞–º–µ—Ç—Ä: ${component.inner_diameter || '?'}–º–º`;
                } else if (type === 'tubes') {
                    subtitle = `–î–∏–∞–º–µ—Ç—Ä: ${component.inner_diameter}–º–º`;
                } else if (type === 'bells') {
                    subtitle = component.type === 'none' ? '–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞' : `–¢–∏–ø: ${component.type}`;
                }
                
                const card = createComponentCard(component.id, type, title, subtitle);
                container.appendChild(card);
            });
        }
        
        function createComponentCard(id, type, title, subtitle) {
            const card = document.createElement('div');
            card.className = 'component-card';
            card.dataset.id = id;
            card.dataset.type = type;
            
            card.innerHTML = `
                <h4>${title}</h4>
                <p>${subtitle}</p>
            `;
            
            card.addEventListener('click', () => selectComponent(id, type));
            
            return card;
        }
        
        function selectComponent(id, type) {
            selectedComponents[type] = id;
            
            const allCards = document.querySelectorAll(`.component-card[data-type="${type}"]`);
            allCards.forEach(card => card.classList.remove('selected'));
            
            const selectedCard = document.querySelector(`.component-card[data-type="${type}"][data-id="${id}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        }
        
        // –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        function updateFinalPreview() {
            const container = document.getElementById('final-preview');
            
            const name = document.getElementById('flute-name').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            const length = document.getElementById('tube-length').value;
            const holes = document.getElementById('hole-count').value;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div>
                        <h4>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                        <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${name}</p>
                        <p><strong>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</strong> ${key}</p>
                        <p><strong>–õ–∞–¥:</strong> ${getScaleName(scaleType)}</p>
                        <p><strong>–î–ª–∏–Ω–∞:</strong> ${length} –º–º</p>
                        <p><strong>–û—Ç–≤–µ—Ä—Å—Ç–∏–π:</strong> ${holes}</p>
                    </div>
                    <div>
                        <h4>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h4>
            `;
            
            ['mouthpiece', 'tube', 'bell'].forEach(type => {
                const card = document.querySelector(`.component-card[data-type="${type}"].selected`);
                html += `<p><strong>${getComponentName(type)}:</strong> ${card ? card.querySelector('h4').textContent : '–ù–µ –≤—ã–±—Ä–∞–Ω'}</p>`;
            });
            
            html += `</div></div>`;
            
            if (Object.keys(notePositions).length > 0) {
                html += `<div style="margin-top: 20px;">
                    <h4>–ö–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (${Object.keys(notePositions).length} –Ω–æ—Ç)</h4>
                    <ul>`;
                
                Object.entries(notePositions).forEach(([note, pos]) => {
                    html += `<li>${note}: ${pos} –º–º</li>`;
                });
                
                html += `</ul></div>`;
            }
            
            container.innerHTML = html;
        }
        
        function getScaleName(scaleType) {
            const names = {
                'major': '–ú–∞–∂–æ—Ä',
                'minor': '–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –º–∏–Ω–æ—Ä',
                'harmonic_minor': '–ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä',
                'melodic_minor': '–ú–µ–ª–æ–¥–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä',
                'pentatonic_major': '–ú–∞–∂–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞',
                'pentatonic_minor': '–ú–∏–Ω–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞',
                'blues': '–ë–ª—é–∑–æ–≤–∞—è –≥–∞–º–º–∞',
                'custom': '–°–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π'
            };
            return names[scaleType] || scaleType;
        }
        
        function getComponentName(type) {
            const names = {
                'mouthpiece': '–ú—É–Ω–¥—à—Ç—É–∫',
                'tube': '–¢—Ä—É–±–∫–∞',
                'bell': '–†–∞—Å—Ç—Ä—É–±'
            };
            return names[type] || type;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–ª–µ–π—Ç—ã
        async function createFluteAdvanced() {
            const name = document.getElementById('flute-name').value.trim();
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            const length = document.getElementById('tube-length').value;
            const holes = document.getElementById('hole-count').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!name) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–ª–µ–π—Ç—ã');
                return;
            }
            
            if (!selectedComponents.tube) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä—É–±–∫—É');
                return;
            }
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ä—Å—Ç–∏—è
            const holesData = Object.entries(notePositions).map(([note, position], index) => ({
                id: index + 1,
                note: note,
                position: parseFloat(position),
                diameter: 8.0, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                angle: (index * 60) % 360,
                is_calibrated: true // –†–∞–∑ –º—ã –≤–≤–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é, –∑–Ω–∞—á–∏—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–æ
            }));
            
            const fluteData = {
                name: name,
                key: key,
                scale: scaleType,
                tube_length: parseInt(length),
                hole_count: parseInt(holes),
                mouthpiece_id: selectedComponents.mouthpiece,
                tube_id: selectedComponents.tube,
                bell_id: selectedComponents.bell,
                custom_notes: JSON.stringify(scaleNotes),
                holes_data: JSON.stringify(holesData),
                is_verified: holesData.length > 0 // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π
            };
            
            try {
                const response = await fetch('/api/flutes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fluteData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ –§–ª–µ–π—Ç–∞ "${name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
                    window.location.href = '/';
                } else {
                    showError(`–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                showError(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        async function createAndCalculateAdvanced() {
            // –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º, –ø–æ—Ç–æ–º —Å–æ–∑–¥–∞–¥–∏–º
            const length = document.getElementById('tube-length').value;
            const key = document.getElementById('key').value;
            const holes = document.getElementById('hole-count').value;
            
            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tube_length: parseInt(length),
                        key: key,
                        hole_count: parseInt(holes),
                        scale: document.getElementById('scale-type').value
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ä–∞—Å—á–µ—Ç–∞
                    result.holes.forEach(hole => {
                        notePositions[hole.note] = hole.position;
                    });
                    
                    updateScaleBuilder();
                    updateNotePreview();
                    
                    // –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º —Ñ–ª–µ–π—Ç—É
                    await createFluteAdvanced();
                } else {
                    showError(`–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                showError(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('create-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>