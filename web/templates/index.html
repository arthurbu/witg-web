<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ WITG - Wind Instrument Template Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé∑</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            text-align: left;
        }
        
        .logo h1 {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 2em;
        }
        
        .logo p {
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .content {
            padding: 30px;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä */
        .editor-main {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .editor-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .editor-title h2 {
            color: #2E7D32;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* –ú–∞—Å—Ç–µ—Ä —à–∞–≥–æ–≤ */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
            padding: 0 20px;
        }
        
        .wizard-steps:before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
            cursor: pointer;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 10px;
            border: 3px solid white;
            transition: all 0.3s;
        }
        
        .step.active .step-circle {
            background: #4CAF50;
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-circle {
            background: #2196F3;
            color: white;
        }
        
        .step-label {
            font-size: 0.9em;
            color: #666;
            transition: all 0.3s;
        }
        
        .step.active .step-label {
            color: #2E7D32;
            font-weight: 600;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        /* –°–µ–∫—Ü–∏–∏ —Ñ–æ—Ä–º—ã */
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s;
        }
        
        .form-section:hover {
            border-color: #4CAF50;
        }
        
        .form-section h3 {
            color: #2E7D32;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .calculated-length {
            color: #666;
            font-style: italic;
            opacity: 0.7;
        }
        
        /* –û–∫—Ç–∞–≤—ã */
        .octave-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .octave-btn {
            padding: 8px 15px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .octave-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        /* –ë–ª—é–∑–æ–≤—ã–µ –Ω–æ—Ç—ã */
        .blue-note-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .blue-note-selector {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #2196F3;
            min-width: 150px;
        }
        
        /* –ü–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å –Ω–æ—Ç */
        .note-builder {
            margin-top: 20px;
        }
        
        .note-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }
        
        .note-item:hover {
            border-color: #4CAF50;
            transform: translateX(5px);
        }
        
        .note-item.blue-note {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .note-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .note-label {
            min-width: 60px;
            font-weight: bold;
            color: #2E7D32;
            font-size: 1.1em;
        }
        
        .note-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .note-position-input {
            width: 120px;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 5px;
        }
        
        .note-position-input.calculated {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .note-calculated-value {
            width: 120px;
            padding: 10px;
            border: 2px dashed #4CAF50;
            border-radius: 5px;
            background: #f0f9f0;
            color: #2E7D32;
            font-weight: 600;
        }
        
        .note-diameter-input {
            width: 100px;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 5px;
        }
        
        /* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã */
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .component-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .component-card:hover {
            border-color: #4CAF50;
            transform: translateY(-3px);
        }
        
        .component-card.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .component-card h4 {
            color: #2E7D32;
            margin-bottom: 5px;
        }
        
        .component-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }
        
        .btn-calculate:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä */
        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            animation: slideIn 0.3s ease;
        }
        
        .preview-section h3 {
            color: #2E7D32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .note-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .note-table th,
        .note-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .note-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2E7D32;
        }
        
        /* –°—Ç–∞—Ç—É—Å—ã –Ω–æ—Ç */
        .note-status-high {
            color: #28a745;
            font-weight: bold;
        }
        
        .note-status-medium {
            color: #ffc107;
            font-weight: bold;
        }
        
        .note-status-low {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* –°–ø–∏—Å–æ–∫ –¥—É–¥–∏–∫—Å–æ–≤ */
        .dudexes-section {
            margin-top: 50px;
        }
        
        .dudexes-section h2 {
            color: #2E7D32;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dudexes-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .dudexes-table th {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .dudexes-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .dudexes-table tr:hover {
            background: #f8f9fa;
        }
        
        .verified-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
        }
        
        .unverified-badge {
            background: #6c757d;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥—É–¥–∏–∫—Å–∞ */
        .dudex-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .dudex-card-header {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dudex-card-content {
            padding: 30px;
        }
        
        .dudex-card-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.success {
            background: #4CAF50;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #2196F3;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .calculating {
            animation: pulse 1s infinite;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .wizard-steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .wizard-steps:before {
                display: none;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .components-grid {
                grid-template-columns: 1fr;
            }
            
            .wizard-actions {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <h1>üé∑ WITG</h1>
                    <p>Wind Instrument Template Generator</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='/manage-components'">
                        üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
                    </button>
                    <button class="btn btn-secondary" onclick="refreshAllData()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
            </div>
        </header>
        
        <div class="content">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
            <div class="editor-main">
                <div class="editor-title">
                    <h2>üéµ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥—É–¥–∏–∫—Å–∞</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="window.location.href='/create-flute'">
                            üÜï –ù–æ–≤—ã–π –¥—É–¥–∏–∫—Å
                        </button>
                    </div>
                </div>
                
                <!-- –ú–∞—Å—Ç–µ—Ä —à–∞–≥–æ–≤ -->
                <div class="wizard-steps">
                    <div class="step active" data-step="1" onclick="goToStep(1)">
                        <div class="step-circle">1</div>
                        <div class="step-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</div>
                    </div>
                    <div class="step" data-step="2" onclick="goToStep(2)">
                        <div class="step-circle">2</div>
                        <div class="step-label">–í—ã–±–æ—Ä –Ω–æ—Ç</div>
                    </div>
                    <div class="step" data-step="3" onclick="goToStep(3)">
                        <div class="step-circle">3</div>
                        <div class="step-label">–ü–æ–∑–∏—Ü–∏–∏</div>
                    </div>
                    <div class="step" data-step="4" onclick="goToStep(4)">
                        <div class="step-circle">4</div>
                        <div class="step-label">–°–æ–∑–¥–∞–Ω–∏–µ</div>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 1: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
                <div id="step-1" class="step-content active">
                    <div class="form-section">
                        <h3>‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="dudex-name">–ù–∞–∑–≤–∞–Ω–∏–µ –¥—É–¥–∏–∫—Å–∞</label>
                                <input type="text" id="dudex-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π –¥—É–¥–∏–∫—Å –≤ D" value="–ú–æ–π –¥—É–¥–∏–∫—Å">
                            </div>
                            
                            <div class="form-group">
                                <label for="key">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
                                <select id="key">
                                    <option value="C">C (–î–æ)</option>
                                    <option value="D" selected>D (–†–µ)</option>
                                    <option value="E">E (–ú–∏)</option>
                                    <option value="F">F (–§–∞)</option>
                                    <option value="G">G (–°–æ–ª—å)</option>
                                    <option value="A">A (–õ—è)</option>
                                    <option value="B">B (–°–∏)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="scale-type">–õ–∞–¥</label>
                                <select id="scale-type">
                                    <option value="major">–ú–∞–∂–æ—Ä (Ionian)</option>
                                    <option value="minor" selected>–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –º–∏–Ω–æ—Ä (Aeolian)</option>
                                    <option value="harmonic_minor">–ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä</option>
                                    <option value="melodic_minor">–ú–µ–ª–æ–¥–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä</option>
                                    <option value="pentatonic_major">–ú–∞–∂–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞</option>
                                    <option value="pentatonic_minor">–ú–∏–Ω–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞</option>
                                    <option value="blues">–ë–ª—é–∑–æ–≤–∞—è –≥–∞–º–º–∞</option>
                                    <option value="dorian">–î–æ—Ä–∏–π—Å–∫–∏–π –ª–∞–¥ (Dorian)</option>
                                    <option value="phrygian">–§—Ä–∏–≥–∏–π—Å–∫–∏–π –ª–∞–¥ (Phrygian)</option>
                                    <option value="lydian">–õ–∏–¥–∏–π—Å–∫–∏–π –ª–∞–¥ (Lydian)</option>
                                    <option value="mixolydian">–ú–∏–∫—Å–æ–ª–∏–¥–∏–π—Å–∫–∏–π –ª–∞–¥ (Mixolydian)</option>
                                    <option value="locrian">–õ–æ–∫—Ä–∏–π—Å–∫–∏–π –ª–∞–¥ (Locrian)</option>
                                    <option value="custom">–°–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="tube-length">–î–ª–∏–Ω–∞ —Ç—Ä—É–±–∫–∏ (–º–º)</label>
                                <input type="number" id="tube-length" value="450" min="200" max="800" step="10">
                                <div id="calculated-length-info" style="font-size: 0.9em; color: #666; margin-top: 5px;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="hole-count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π</label>
                                <select id="hole-count">
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6" selected>6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>–û–∫—Ç–∞–≤—ã</label>
                            <div class="octave-selector">
                                <button type="button" class="octave-btn" data-octave="1" onclick="toggleOctave(1)">1</button>
                                <button type="button" class="octave-btn" data-octave="2" onclick="toggleOctave(2)">2</button>
                                <button type="button" class="octave-btn active" data-octave="3" onclick="toggleOctave(3)">3</button>
                                <button type="button" class="octave-btn active" data-octave="4" onclick="toggleOctave(4)">4</button>
                                <button type="button" class="octave-btn" data-octave="5" onclick="toggleOctave(5)">5</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>üé∂ –û—Å–æ–±—ã–µ –Ω–æ—Ç—ã</h3>
                        <div class="blue-note-control">
                            <select id="blue-note-select" class="blue-note-selector">
                                <option value="b3">b3 (–ú–∞–ª–∞—è —Ç–µ—Ä—Ü–∏—è)</option>
                                <option value="b5">b5 (–¢—Ä–∏—Ç–æ–Ω)</option>
                                <option value="b7">b7 (–ú–∞–ª–∞—è —Å–µ–ø—Ç–∏–º–∞)</option>
                                <option value="#9">#9 (–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –Ω–æ–Ω–∞)</option>
                                <option value="#11">#11 (–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —É–Ω–¥–µ—Ü–∏–º–∞)</option>
                                <option value="b9">b9 (–ü–æ–Ω–∏–∂–µ–Ω–Ω–∞—è –Ω–æ–Ω–∞)</option>
                            </select>
                            <button class="btn btn-secondary" onclick="addSpecialNote()">+ –î–æ–±–∞–≤–∏—Ç—å –æ—Å–æ–±—É—é –Ω–æ—Ç—É</button>
                        </div>
                        <div id="special-notes-list"></div>
                    </div>
                    
                    <div class="form-section">
                        <h3>üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>üéµ –¢—Ä—É–±–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                <div class="components-grid" id="tubes-cards">
                                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä—É–±–æ–∫...</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>üé∫ –ú—É–Ω–¥—à—Ç—É–∫ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                <div class="components-grid" id="mouthpieces-cards">
                                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–Ω–¥—à—Ç—É–∫–æ–≤...</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>üé∑ –†–∞—Å—Ç—Ä—É–± (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <div class="components-grid" id="bells-cards">
                                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç—Ä—É–±–æ–≤...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wizard-actions">
                        <button class="btn btn-secondary" onclick="clearEditor()">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button class="btn btn-primary" onclick="validateComponentsAndGoToStep2()">
                            –î–∞–ª–µ–µ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –Ω–æ—Ç -->
                <div id="step-2" class="step-content">
                    <div class="form-section">
                        <h3>üéµ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ—Ç—ã –¥–ª—è –¥—É–¥–∏–∫—Å–∞</h3>
                        <p>–û—Ç–º–µ—Ç—å—Ç–µ —á–µ–∫–±–æ–∫—Å–∞–º–∏ –Ω–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –Ω–∞ –≤–∞—à–µ–º –¥—É–¥–∏–∫—Å–µ (–Ω–µ –±–æ–ª–µ–µ <span id="max-holes">6</span> –Ω–æ—Ç)</p>
                        
                        <div class="note-builder" id="note-selector">
                            <!-- –ù–æ—Ç—ã –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                        </div>
                        
                        <div class="wizard-actions" style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="selectAllNotes()">
                                ‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                            </button>
                            <button class="btn btn-secondary" onclick="deselectAllNotes()">
                                ‚ùå –°–Ω—è—Ç—å –≤—Å–µ
                            </button>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <h3>üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–æ—Ç—ã</h3>
                        <div id="selected-notes-preview">
                            <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–æ—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                    
                    <div class="wizard-actions">
                        <button class="btn btn-secondary" onclick="goToStep(1)">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                        <button class="btn btn-primary" onclick="goToStep(3)">
                            –î–∞–ª–µ–µ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 3: –ü–æ–∑–∏—Ü–∏–∏ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π -->
                <div id="step-3" class="step-content">
                    <div class="form-section">
                        <h3>üìê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∑–∏—Ü–∏–π –æ—Ç–≤–µ—Ä—Å—Ç–∏–π</h3>
                        <p>–í–≤–µ–¥–∏—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π (–º–º –æ—Ç –º—É–Ω–¥—à—Ç—É–∫–∞) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∞—Å—á–µ—Ç —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</p>
                        
                        <div class="note-builder" id="positions-builder">
                            <!-- –ü–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                        </div>
                        
                        <div class="wizard-actions" style="margin-top: 20px;">
                            <button class="btn btn-calculate" onclick="calculateAllPositions()" id="calculate-btn">
                                üìê –ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
                            </button>
                        </div>
                    </div>
                    
                    <div class="preview-section" id="holes-preview">
                        <h3>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–≤–µ—Ä—Å—Ç–∏–π</h3>
                        <table class="note-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>–ù–æ—Ç–∞</th>
                                    <th>–ü–æ–∑–∏—Ü–∏—è (–º–º)</th>
                                    <th>–î–∏–∞–º–µ—Ç—Ä (–º–º)</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å</th>
                                </tr>
                            </thead>
                            <tbody id="preview-table">
                                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="wizard-actions">
                        <button class="btn btn-secondary" onclick="goToStep(2)">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                        <button class="btn btn-primary" onclick="goToStep(4)">
                            –î–∞–ª–µ–µ ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ -->
                <div id="step-4" class="step-content">
                    <div class="form-section">
                        <h3>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                        <div id="final-preview">
                            <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                        <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                            <label>
                                <input type="checkbox" id="is-verified-checkbox">
                                ‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω (–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏)
                            </label>
                        </div>
                        <p style="color: #666; font-size: 0.9em;">
                            –û—Ç–º–µ—Ç—å—Ç–µ, –µ—Å–ª–∏ –≤—ã –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –∑–≤—É—á–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–π –æ—Ç–≤–µ—Ä—Å—Ç–∏–π
                        </p>
                    </div>
                    
                    <div id="create-error" class="error" style="display: none; color: #dc3545; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;"></div>
                    
                    <div class="wizard-actions">
                        <button class="btn btn-secondary" onclick="goToStep(3)">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                        <button class="btn btn-primary" onclick="saveDudex()" id="save-btn">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥—É–¥–∏–∫—Å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –¥—É–¥–∏–∫—Å–æ–≤ -->
            <div class="dudexes-section">
                <h2>üìã –ú–æ–∏ –¥—É–¥–∏–∫—Å—ã</h2>
                <div class="loading" id="dudexes-loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥—É–¥–∏–∫—Å–æ–≤...
                </div>
                <div id="dudexes-container" style="display: none;">
                    <table class="dudexes-table">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</th>
                                <th>–î–ª–∏–Ω–∞</th>
                                <th>–û—Ç–≤–µ—Ä—Å—Ç–∏–π</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="dudexes-list">
                            <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification-container"></div>
    
    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
       let selectedComponents = {
    mouthpiece: null,
    tube: null,
    bell: null
};
        
        let selectedOctaves = [3, 4];
        let specialNotes = [];
        let allPossibleNotes = [];
        let selectedNotes = [];
        let notePositions = {};
        let noteDiameters = {};
        let calculatedPositions = {};
        let isVerified = false;
        
        // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        let componentsData = {
            mouthpieces: [],
            tubes: [],
            bells: []
        };
        
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SCALES = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            harmonic_minor: [0, 2, 3, 5, 7, 8, 11],
            melodic_minor: [0, 2, 3, 5, 7, 9, 11],
            pentatonic_major: [0, 2, 4, 7, 9],
            pentatonic_minor: [0, 3, 5, 7, 10],
            blues: [0, 3, 5, 6, 7, 10],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10]
        };
        
        const SPECIAL_NOTE_INTERVALS = {
            'b3': 3, 'b5': 6, 'b7': 10,
            '#9': 3, '#11': 6, 'b9': 1
        };
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º selectedComponents
    selectedComponents = {
        mouthpiece: null,
        tube: null,
        bell: null
    };
    
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ selectedComponents:', selectedComponents);
    
    loadComponents();
    generateAllPossibleNotes();
    updateSpecialNotesList();
    loadDudexes();
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    document.getElementById('key').addEventListener('change', function() {
        generateAllPossibleNotes();
        calculateTubeLength();
    });
    document.getElementById('scale-type').addEventListener('change', function() {
        generateAllPossibleNotes();
        calculateTubeLength();
    });
    document.getElementById('hole-count').addEventListener('change', updateMaxHolesDisplay);
    
    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
    document.getElementById('is-verified-checkbox').addEventListener('change', function() {
        isVerified = this.checked;
    });
    
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
});
        document.addEventListener('DOMContentLoaded', function() {
            loadComponents();
            generateAllPossibleNotes();
            updateSpecialNotesList();
            loadDudexes();
            
            // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            document.getElementById('key').addEventListener('change', function() {
                generateAllPossibleNotes();
                calculateTubeLength();
            });
            document.getElementById('scale-type').addEventListener('change', function() {
                generateAllPossibleNotes();
                calculateTubeLength();
            });
            document.getElementById('hole-count').addEventListener('change', updateMaxHolesDisplay);
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
            document.getElementById('is-verified-checkbox').addEventListener('change', function() {
                isVerified = this.checked;
            });
        });
        
        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –®–ê–ì–ê–ú–ò ==========
        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`step-${step}`).classList.add('active');
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
            for (let i = 1; i < step; i++) {
                document.querySelector(`.step[data-step="${i}"]`).classList.add('completed');
            }
            
            if (step === 2) {
                updateNoteSelector();
                updateSelectedNotesPreview();
            } else if (step === 3) {
                updatePositionsBuilder();
                updatePreview();
            } else if (step === 4) {
                updateFinalPreview();
            }
        }
        
       function validateComponentsAndGoToStep2() {
    console.log('=== –ü–†–û–í–ï–†–ö–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í ===');
    console.log('selectedComponents:', selectedComponents);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    if (!selectedComponents.tube) {
        console.log('–¢—Ä—É–±–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:', selectedComponents.tube);
        
        // –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—â–µ —Ä–∞–∑
        if (componentsData.tubes && componentsData.tubes.length > 0) {
            const tube = componentsData.tubes[0];
            selectedComponents.tube = parseInt(tube.id);
            console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–ª–∏ —Ç—Ä—É–±–∫—É:', tube.id);
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ–º
            const tubeCard = document.querySelector(`.component-card[data-type="tubes"][data-id="${tube.id}"]`);
            if (tubeCard) {
                tubeCard.classList.add('selected');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ —Ç—Ä—É–±–∫–∞: ${tube.name}`, 'info');
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏–Ω—É
            calculateTubeLength();
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
            goToStep(2);
            return;
        } else {
            showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä—É–±–∫—É', 'warning');
            return;
        }
    }
    
    if (!selectedComponents.mouthpiece) {
        console.log('–ú—É–Ω–¥—à—Ç—É–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω, —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:', selectedComponents.mouthpiece);
        
        // –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        if (componentsData.mouthpieces && componentsData.mouthpieces.length > 0) {
            const mouthpiece = componentsData.mouthpieces[0];
            selectedComponents.mouthpiece = parseInt(mouthpiece.id);
            console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–ª–∏ –º—É–Ω–¥—à—Ç—É–∫:', mouthpiece.id);
            
            const mouthpieceCard = document.querySelector(`.component-card[data-type="mouthpieces"][data-id="${mouthpiece.id}"]`);
            if (mouthpieceCard) {
                mouthpieceCard.classList.add('selected');
            }
            
            showNotification(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω –º—É–Ω–¥—à—Ç—É–∫: ${mouthpiece.name}`, 'info');
            calculateTubeLength();
            goToStep(2);
            return;
        } else {
            showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–¥—à—Ç—É–∫', 'warning');
            return;
        }
    }
    
    console.log('‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤—ã–±—Ä–∞–Ω—ã! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 2');
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç—Ä—É–±–∫–∏
    calculateTubeLength();
    
    goToStep(2);

    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    if (selectedComponents.tube === null || selectedComponents.tube === undefined) {
        console.log('‚ùå –¢—Ä—É–±–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞!');
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä—É–±–∫—É', 'warning');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–¥–µ –≤—ã–±—Ä–∞—Ç—å
        const tubeSection = document.querySelector('.form-section:nth-child(3)');
        if (tubeSection) {
            tubeSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ
        const tubeCards = document.getElementById('tubes-cards');
        if (tubeCards) {
            tubeCards.style.border = '2px solid #dc3545';
            tubeCards.style.padding = '10px';
            tubeCards.style.borderRadius = '8px';
            
            setTimeout(() => {
                tubeCards.style.border = '';
                tubeCards.style.padding = '';
            }, 3000);
        }
        
        return;
    }
    
    if (selectedComponents.mouthpiece === null || selectedComponents.mouthpiece === undefined) {
        console.log('‚ùå –ú—É–Ω–¥—à—Ç—É–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω!');
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–¥—à—Ç—É–∫', 'warning');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–¥–µ –≤—ã–±—Ä–∞—Ç—å
        const mouthpieceSection = document.querySelector('.form-section:nth-child(3)');
        if (mouthpieceSection) {
            mouthpieceSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ
        const mouthpieceCards = document.getElementById('mouthpieces-cards');
        if (mouthpieceCards) {
            mouthpieceCards.style.border = '2px solid #dc3545';
            mouthpieceCards.style.padding = '10px';
            mouthpieceCards.style.borderRadius = '8px';
            
            setTimeout(() => {
                mouthpieceCards.style.border = '';
                mouthpieceCards.style.padding = '';
            }, 3000);
        }
        
        return;
    }
    
    console.log('‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤—ã–±—Ä–∞–Ω—ã!');
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç—Ä—É–±–∫–∏
    calculateTubeLength();
    
    goToStep(2);
}
        
        // ========== –†–ê–°–ß–ï–¢ –î–õ–ò–ù–´ –¢–†–£–ë–ö–ò ==========
        function calculateTubeLength() {
            if (!selectedComponents.tube || !selectedComponents.mouthpiece) {
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            const tube = componentsData.tubes.find(t => t.id === selectedComponents.tube);
            const mouthpiece = componentsData.mouthpieces.find(m => m.id === selectedComponents.mouthpiece);
            const bell = selectedComponents.bell ? componentsData.bells.find(b => b.id === selectedComponents.bell) : null;
            
            if (!tube || !mouthpiece) return;
            
            // –ë–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–ª–∏–Ω—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            const holeCount = parseInt(document.getElementById('hole-count').value);
            
            // –ë–∞–∑–æ–≤–∞—è –¥–ª–∏–Ω–∞ –¥–ª—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ D
            let baseLength = 450;
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
            const keyLengths = {
                'C': 520, 'D': 450, 'E': 400, 'F': 390,
                'G': 350, 'A': 310, 'B': 280
            };
            baseLength = keyLengths[key] || baseLength;
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∏–∞–º–µ—Ç—Ä—É —Ç—Ä—É–±–∫–∏
            if (tube.d_in) {
                const diameterFactor = tube.d_in / 20; // –ë–∞–∑–æ–≤—ã–π –¥–∏–∞–º–µ—Ç—Ä 20–º–º
                baseLength *= diameterFactor;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª–∏–Ω—É –º—É–Ω–¥—à—Ç—É–∫–∞
            if (mouthpiece.length) {
                baseLength += mouthpiece.length;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª–∏–Ω—É —Ä–∞—Å—Ç—Ä—É–±–∞
            if (bell && bell.length) {
                baseLength += bell.length;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –¥–ª–∏–Ω—É
            const lengthInput = document.getElementById('tube-length');
            lengthInput.value = Math.round(baseLength);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—á–µ—Ç–µ
            const infoDiv = document.getElementById('calculated-length-info');
            infoDiv.innerHTML = `~${Math.round(baseLength)} –º–º (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)`;
        }
        
        // ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
        function toggleOctave(octave) {
            const btn = document.querySelector(`.octave-btn[data-octave="${octave}"]`);
            if (selectedOctaves.includes(octave)) {
                selectedOctaves = selectedOctaves.filter(o => o !== octave);
                btn.classList.remove('active');
            } else {
                selectedOctaves.push(octave);
                selectedOctaves.sort((a, b) => a - b);
                btn.classList.add('active');
            }
            generateAllPossibleNotes();
        }
        
        function updateMaxHolesDisplay() {
            const holeCount = parseInt(document.getElementById('hole-count').value);
            document.getElementById('max-holes').textContent = holeCount;
        }
        
        // ========== –ì–ï–ù–ï–†–ê–¶–ò–Ø –í–°–ï–• –í–û–ó–ú–û–ñ–ù–´–• –ù–û–¢ ==========
        function generateAllPossibleNotes() {
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            
            const tonicIndex = NOTE_NAMES.indexOf(key);
            if (tonicIndex === -1) return;
            
            let intervals = SCALES[scaleType] || SCALES.minor;
            
            allPossibleNotes = [];
            selectedOctaves.forEach(octave => {
                intervals.forEach(interval => {
                    const noteIndex = (tonicIndex + interval) % 12;
                    const noteName = NOTE_NAMES[noteIndex];
                    const fullNote = `${noteName}${octave}`;
                    
                    if (!allPossibleNotes.includes(fullNote)) {
                        allPossibleNotes.push(fullNote);
                    }
                });
            });
            
            specialNotes.forEach(note => {
                if (!allPossibleNotes.includes(note)) {
                    allPossibleNotes.push(note);
                }
            });
            
            allPossibleNotes.sort((a, b) => {
                const octaveA = parseInt(a.replace(/[^0-9]/g, ''));
                const octaveB = parseInt(b.replace(/[^0-9]/g, ''));
                const noteA = a.replace(/[0-9]/g, '');
                const noteB = b.replace(/[0-9]/g, '');
                
                if (octaveA !== octaveB) return octaveA - octaveB;
                return NOTE_NAMES.indexOf(noteA) - NOTE_NAMES.indexOf(noteB);
            });
            
            selectedNotes = selectedNotes.filter(note => allPossibleNotes.includes(note));
            
            updateNoteSelector();
        }
        
        function addSpecialNote() {
            const key = document.getElementById('key').value;
            const specialNoteType = document.getElementById('blue-note-select').value;
            const holeCount = parseInt(document.getElementById('hole-count').value);
            
            const tonicIndex = NOTE_NAMES.indexOf(key);
            const interval = SPECIAL_NOTE_INTERVALS[specialNoteType];
            
            selectedOctaves.forEach(octave => {
                const noteIndex = (tonicIndex + interval) % 12;
                const noteName = NOTE_NAMES[noteIndex];
                const fullNote = `${noteName}${octave}`;
                
                if (specialNotes.length < 10 && !specialNotes.includes(fullNote)) {
                    specialNotes.push(fullNote);
                }
            });
            
            generateAllPossibleNotes();
            updateSpecialNotesList();
            showNotification('–û—Å–æ–±–∞—è –Ω–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
        }
        
        function updateSpecialNotesList() {
            const container = document.getElementById('special-notes-list');
            container.innerHTML = '';
            
            if (specialNotes.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 10px;">–û—Å–æ–±—ã–µ –Ω–æ—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                return;
            }
            
            specialNotes.forEach((note, index) => {
                const div = document.createElement('div');
                div.className = 'note-item blue-note';
                div.innerHTML = `
                    <span class="note-label">${note}</span>
                    <span style="flex: 1;">–û—Å–æ–±–∞—è –Ω–æ—Ç–∞</span>
                    <button onclick="removeSpecialNote(${index})" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                `;
                container.appendChild(div);
            });
        }
        
        function removeSpecialNote(index) {
            specialNotes.splice(index, 1);
            generateAllPossibleNotes();
            updateSpecialNotesList();
            showNotification('–û—Å–æ–±–∞—è –Ω–æ—Ç–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
        }
        
      // ========== –ö–û–ú–ü–û–ù–ï–ù–¢–´ ==========
async function loadComponents() {
    try {
        const [mpRes, tubesRes, bellsRes] = await Promise.all([
            fetch('/api/mouthpieces'),
            fetch('/api/tubes'),
            fetch('/api/bells')
        ]);
        
        const mpData = await mpRes.json();
        const tubesData = await tubesRes.json();
        const bellsData = await bellsRes.json();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        componentsData.mouthpieces = mpData.mouthpieces || [];
        componentsData.tubes = tubesData.tubes || [];
        componentsData.bells = bellsData.bells || [];
        
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:', {
            tubes: componentsData.tubes.length,
            mouthpieces: componentsData.mouthpieces.length,
            bells: componentsData.bells.length
        });
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        renderComponents('tubes', componentsData.tubes);
        renderComponents('mouthpieces', componentsData.mouthpieces);
        renderComponents('bells', componentsData.bells);
        
        // –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        setTimeout(() => {
            autoSelectComponents();
        }, 100);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤', 'error');
    }
}

function autoSelectComponents() {
    console.log('=== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –í–´–ë–û–† –ö–û–ú–ü–û–ù–ï–ù–¢–û–í ===');
    console.log('componentsData.tubes:', componentsData.tubes);
    console.log('componentsData.mouthpieces:', componentsData.mouthpieces);
    
    // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —Ç—Ä—É–±–∫—É
    if (componentsData.tubes && componentsData.tubes.length > 0) {
        const tube = componentsData.tubes[0];
        console.log('–í—ã–±–∏—Ä–∞–µ–º —Ç—Ä—É–±–∫—É:', tube);
        
        // –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        selectedComponents.tube = parseInt(tube.id);
        
        // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        const tubeCard = document.querySelector(`.component-card[data-type="tubes"][data-id="${tube.id}"]`);
        if (tubeCard) {
            tubeCard.classList.add('selected');
            console.log('–¢—Ä—É–±–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–∞');
        }
        
        showNotification(`–¢—Ä—É–±–∫–∞ –≤—ã–±—Ä–∞–Ω–∞: ${tube.name}`, 'info');
    }
    
    // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –º—É–Ω–¥—à—Ç—É–∫
    if (componentsData.mouthpieces && componentsData.mouthpieces.length > 0) {
        const mouthpiece = componentsData.mouthpieces[0];
        console.log('–í—ã–±–∏—Ä–∞–µ–º –º—É–Ω–¥—à—Ç—É–∫:', mouthpiece);
        
        selectedComponents.mouthpiece = parseInt(mouthpiece.id);
        
        const mouthpieceCard = document.querySelector(`.component-card[data-type="mouthpieces"][data-id="${mouthpiece.id}"]`);
        if (mouthpieceCard) {
            mouthpieceCard.classList.add('selected');
            console.log('–ú—É–Ω–¥—à—Ç—É–∫ –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª–µ–Ω');
        }
        
        showNotification(`–ú—É–Ω–¥—à—Ç—É–∫ –≤—ã–±—Ä–∞–Ω: ${mouthpiece.name}`, 'info');
    }
    
    // –î–ª—è —Ä–∞—Å—Ç—Ä—É–±–∞ –≤—ã–±–∏—Ä–∞–µ–º "–ë–µ–∑"
    console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å—Ç—Ä—É–± –∫–∞–∫ "–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞"');
    selectedComponents.bell = null;
    
    const bellCard = document.querySelector('.component-card[data-type="bells"][data-id="none"]');
    if (bellCard) {
        bellCard.classList.add('selected');
        console.log('–†–∞—Å—Ç—Ä—É–± –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª–µ–Ω –∫–∞–∫ "–ë–µ–∑"');
    }
    
    console.log('–ò—Ç–æ–≥–æ–≤—ã–π selectedComponents:', selectedComponents);
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç—Ä—É–±–∫–∏
    setTimeout(() => {
        calculateTubeLength();
    }, 200);
}

function renderComponents(type, components) {
    const container = document.getElementById(`${type}-cards`);
    if (!container) return;
    
    container.innerHTML = '';
    
    console.log(`–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ${type}:`, components);
    
    // –î–ª—è —Ä–∞—Å—Ç—Ä—É–±–∞ –¥–æ–±–∞–≤–ª—è–µ–º "–ë–µ–∑"
    if (type === 'bells') {
        const noneCard = createComponentCard(null, type, '–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞', '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ç—Ä—É–±–∫–∞', '');
        container.appendChild(noneCard);
    }
    
    if (components && components.length > 0) {
        components.forEach(component => {
            let subtitle = '';
            let details = '';
            
            if (type === 'mouthpieces') {
                subtitle = component.type || '';
                details = `d_tip: ${component.d_tip || '?'}–º–º, Œ¥_m: ${component.delta_m || '?'}–º–º`;
            } else if (type === 'tubes') {
                subtitle = getMaterialName(component.material) || '';
                details = `–î–∏–∞–º–µ—Ç—Ä: ${component.d_in || '?'}–º–º, V_eff: ${component.v_eff ? (component.v_eff/1000).toFixed(1) : '343'} –º/—Å`;
            } else if (type === 'bells') {
                subtitle = component.type || '';
                details = component.type === 'none' ? '–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞' : `ŒîL: ${component.delta_L || 0}–º–º`;
            }
            
            const card = createComponentCard(
                component.id, 
                type, 
                component.name, 
                subtitle,
                details,
                false // –Ω–µ –≤—ã–¥–µ–ª—è–µ–º –∑–¥–µ—Å—å
            );
            container.appendChild(card);
        });
    } else {
        container.innerHTML = '<div class="loading">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</div>';
    }
}
    
    console.log(`–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ${type} –∑–∞–≤–µ—Ä—à–µ–Ω, –≤—ã–±—Ä–∞–Ω:`, selectedComponents[type]);


function createComponentCard(id, type, title, subtitle, details, isSelected = false) {
    const card = document.createElement('div');
    card.className = 'component-card';
    if (isSelected) card.classList.add('selected');
    
    card.dataset.id = id !== null ? id : 'none';
    card.dataset.type = type;
    card.dataset.title = title;
    card.dataset.subtitle = subtitle;
    card.dataset.details = details;
    
    card.innerHTML = `
        <h4>${title}</h4>
        ${subtitle ? `<div class="component-details">${subtitle}</div>` : ''}
        ${details ? `<div class="component-details">${details}</div>` : ''}
    `;
    
    card.addEventListener('click', () => {
        console.log('–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ:', {type, id, title});
        if (id !== null) {
            selectComponent(id, type, title);
        } else {
            // –î–ª—è "–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞"
            selectComponent(null, type, '–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞');
        }
    });
    
    return card;
}

function selectComponent(id, type, title) {
    console.log(`–í—ã–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: ${type} = ${id} (${title})`);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    if (id === null) {
        selectedComponents[type] = null;
    } else {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º id –≤ —á–∏—Å–ª–æ
        selectedComponents[type] = parseInt(id);
    }
    
    console.log('–û–±–Ω–æ–≤–ª—è–µ–º selectedComponents:', selectedComponents);
    
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
    const allCards = document.querySelectorAll(`.component-card[data-type="${type}"]`);
    allCards.forEach(card => card.classList.remove('selected'));
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    const cardId = id !== null ? id : 'none';
    const selectedCard = document.querySelector(`.component-card[data-type="${type}"][data-id="${cardId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
        console.log(`–í—ã–¥–µ–ª–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫—É ${type} —Å ID ${cardId}`);
        showNotification(`${getComponentName(type)} –≤—ã–±—Ä–∞–Ω: ${title}`, 'info');
    } else {
        console.warn(`–ö–∞—Ä—Ç–æ—á–∫–∞ ${type} —Å ID ${cardId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);
    }
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç—Ä—É–±–∫–∏
    calculateTubeLength();
    
    console.log('–¢–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:', selectedComponents);
}

function getComponentName(type) {
    const names = {
        'mouthpieces': '–º—É–Ω–¥—à—Ç—É–∫',
        'tubes': '—Ç—Ä—É–±–∫–∞',
        'bells': '—Ä–∞—Å—Ç—Ä—É–±'
    };
    return names[type] || type;
}

function getMaterialName(materialCode) {
    const materials = {
        'pvc': '–ü–í–•',
        'bamboo': '–ë–∞–º–±—É–∫',
        'wood': '–î–µ—Ä–µ–≤–æ',
        'metal': '–ú–µ—Ç–∞–ª–ª',
        'plastic': '–ü–ª–∞—Å—Ç–∏–∫',
        'composite': '–ö–æ–º–ø–æ–∑–∏—Ç'
    };
    return materials[materialCode] || materialCode;
}
        
        // ========== –í–´–ë–û–† –ù–û–¢ ==========
        function updateNoteSelector() {
            const container = document.getElementById('note-selector');
            container.innerHTML = '';
            
            if (allPossibleNotes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≥–∞–º–º—É –Ω–∞ —à–∞–≥–µ 1</p>';
                return;
            }
            
            allPossibleNotes.forEach((note) => {
                const isSpecial = specialNotes.includes(note);
                const isSelected = selectedNotes.includes(note);
                
                const noteDiv = document.createElement('div');
                noteDiv.className = `note-item ${isSpecial ? 'blue-note' : ''}`;
                noteDiv.innerHTML = `
                    <input type="checkbox" class="note-checkbox" 
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleNoteSelection('${note}', this.checked)">
                    <span class="note-label">${note}</span>
                    <span style="flex: 1;">${isSpecial ? '–û—Å–æ–±–∞—è –Ω–æ—Ç–∞' : '–û—Å–Ω–æ–≤–Ω–∞—è –Ω–æ—Ç–∞'}</span>
                `;
                container.appendChild(noteDiv);
            });
        }
        
        function toggleNoteSelection(note, isChecked) {
            const holeCount = parseInt(document.getElementById('hole-count').value);
            
            if (isChecked) {
                if (selectedNotes.length < holeCount) {
                    selectedNotes.push(note);
                } else {
                    showNotification(`–ú–∞–∫—Å–∏–º—É–º ${holeCount} –Ω–æ—Ç! –°–Ω–∏–º–∏—Ç–µ –≤—ã–±–æ—Ä —Å –¥—Ä—É–≥–æ–π –Ω–æ—Ç—ã.`, 'warning');
                    return false;
                }
            } else {
                selectedNotes = selectedNotes.filter(n => n !== note);
            }
            
            updateSelectedNotesPreview();
            return true;
        }
        
        function selectAllNotes() {
            const holeCount = parseInt(document.getElementById('hole-count').value);
            selectedNotes = allPossibleNotes.slice(0, holeCount);
            updateNoteSelector();
            updateSelectedNotesPreview();
            showNotification(`–í—ã–±—Ä–∞–Ω–æ ${selectedNotes.length} –Ω–æ—Ç`, 'info');
        }
        
        function deselectAllNotes() {
            selectedNotes = [];
            updateNoteSelector();
            updateSelectedNotesPreview();
            showNotification('–í—Å–µ –Ω–æ—Ç—ã —Å–Ω—è—Ç—ã', 'info');
        }
        
        function updateSelectedNotesPreview() {
            const container = document.getElementById('selected-notes-preview');
            const holeCount = parseInt(document.getElementById('hole-count').value);
            
            if (selectedNotes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–ù–æ—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>';
                return;
            }
            
            container.innerHTML = `
                <p style="margin-bottom: 10px;">
                    <strong>–í—ã–±—Ä–∞–Ω–æ ${selectedNotes.length} –∏–∑ ${holeCount} –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω–æ—Ç:</strong>
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${selectedNotes.map((note, index) => `
                        <span style="padding: 5px 10px; background: ${specialNotes.includes(note) ? '#e3f2fd' : '#e8f5e9'}; 
                              border: 1px solid ${specialNotes.includes(note) ? '#2196F3' : '#4CAF50'}; 
                              border-radius: 5px; font-weight: bold;">
                            ${index + 1}. ${note}
                        </span>
                    `).join('')}
                </div>
            `;
        }
        
        // ========== –ü–û–ó–ò–¶–ò–ò –û–¢–í–ï–†–°–¢–ò–ô ==========
        function updatePositionsBuilder() {
            const container = document.getElementById('positions-builder');
            container.innerHTML = '';
            
            if (selectedNotes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ—Ç—ã –Ω–∞ —à–∞–≥–µ 2</p>';
                return;
            }
            
            selectedNotes.forEach((note, index) => {
                const isSpecial = specialNotes.includes(note);
                const manualPosition = notePositions[note] || '';
                const calculation = calculatedPositions[note];
                const calculatedPosition = calculation ? calculation.position : '';
                const diameter = noteDiameters[note] || 8.0;
                
                const noteDiv = document.createElement('div');
                noteDiv.className = `note-item ${isSpecial ? 'blue-note' : ''}`;
                
                let sourceBadge = '';
                if (calculation) {
                    if (calculation.source === 'calibrated') {
                        sourceBadge = `<span style="padding: 2px 6px; background: #4CAF50; color: white; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>`;
                    } else {
                        sourceBadge = `<span style="padding: 2px 6px; background: #2196F3; color: white; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">üìê –†–∞—Å—á–µ—Ç</span>`;
                    }
                }
                
                noteDiv.innerHTML = `
                    <span class="note-label">${note}${sourceBadge}</span>
                    <div class="note-input-group">
                        <input type="number" class="note-position-input" 
                               placeholder="–í–∞—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
                               value="${manualPosition}"
                               oninput="updateNotePosition('${note}', this.value)">
                        <span>–º–º</span>
                        ${calculatedPosition ? `
                            <div class="note-calculated-value" title="${calculation.source === 'calibrated' ? '–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ' : '–†–∞—Å—á–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ'}">
                                ${calculatedPosition} –º–º
                                ${calculation.confidence ? `<br><small>–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å: ${Math.round(calculation.confidence * 100)}%</small>` : ''}
                            </div>
                            <button onclick="useCalculatedPosition('${note}')" style="padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üëÜ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                            </button>
                        ` : ''}
                        <input type="number" class="note-diameter-input" 
                               placeholder="–î–∏–∞–º–µ—Ç—Ä"
                               value="${diameter}"
                               oninput="updateNoteDiameter('${note}', this.value)">
                        <span>–º–º</span>
                    </div>
                    <button onclick="calculateSingleNote('${note}')" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üìê
                    </button>
                `;
                container.appendChild(noteDiv);
            });
            
            updatePreview();
        }
        
        function updateNotePosition(note, value) {
            if (value) {
                notePositions[note] = parseFloat(value);
            } else {
                delete notePositions[note];
            }
            updatePreview();
        }
        
        function updateNoteDiameter(note, value) {
            if (value) {
                noteDiameters[note] = parseFloat(value);
            } else {
                delete noteDiameters[note];
            }
        }
        
        function useCalculatedPosition(note) {
            if (calculatedPositions[note]) {
                notePositions[note] = calculatedPositions[note].position;
                updatePositionsBuilder();
                showNotification(`–ü–æ–∑–∏—Ü–∏—è –¥–ª—è ${note} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ`, 'success');
            }
        }
        
        // ========== –†–ê–°–ß–ï–¢ –ü–û–ó–ò–¶–ò–ô ==========
        async function calculateAllPositions() {
            const tubeLength = parseInt(document.getElementById('tube-length').value);
            
            if (selectedNotes.length === 0) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ—Ç—ã –Ω–∞ —à–∞–≥–µ 2', 'warning');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            if (!selectedComponents.tube) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä—É–±–∫—É', 'warning');
                return;
            }
            if (!selectedComponents.mouthpiece) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–¥—à—Ç—É–∫', 'warning');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                const tube = componentsData.tubes.find(t => t.id === selectedComponents.tube);
                const mouthpiece = componentsData.mouthpieces.find(m => m.id === selectedComponents.mouthpiece);
                
                if (!tube || !mouthpiece) {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤', 'error');
                    return;
                }
                
                showNotification('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç —Å —É—á–µ—Ç–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...', 'info');
                document.getElementById('calculate-btn').classList.add('calculating');
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
                const calculationData = {
                    notes: selectedNotes,
                    tube_length: tubeLength,
                    tube_diameter: tube.d_in || 20.0,
                    tube_material: tube.material || 'pvc',
                    mouthpiece_end_correction: mouthpiece.end_correction || 15.0
                };
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
                const response = await fetch('/api/calculate/advanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(calculationData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
                    calculatedPositions = {};
                    result.holes.forEach(hole => {
                        calculatedPositions[hole.note] = {
                            position: hole.position,
                            source: hole.source,
                            is_verified: hole.is_verified,
                            confidence: hole.confidence,
                            calculated_value: hole.calculated_value || hole.position
                        };
                    });
                    
                    updatePositionsBuilder();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    const calibratedCount = result.calibrated_count || 0;
                    const calculatedCount = result.calculated_count || 0;
                    
                    showNotification(
                        `–†–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${calibratedCount}, –†–∞—Å—á–µ—Ç–Ω—ã—Ö: ${calculatedCount}`,
                        'success'
                    );
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            } finally {
                document.getElementById('calculate-btn').classList.remove('calculating');
            }
        }
        
        async function calculateSingleNote(note) {
            const tubeLength = parseInt(document.getElementById('tube-length').value);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            if (!selectedComponents.tube) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä—É–±–∫—É', 'warning');
                return;
            }
            if (!selectedComponents.mouthpiece) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–¥—à—Ç—É–∫', 'warning');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                const tube = componentsData.tubes.find(t => t.id === selectedComponents.tube);
                
                if (!tube) {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä—É–±–∫–∏', 'error');
                    return;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
                const response = await fetch('/api/calculate/single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        note: note,
                        tube_length: tubeLength,
                        tube_diameter: tube.d_in || 20.0,
                        tube_material: tube.material || 'pvc'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    calculatedPositions[note] = {
                        position: result.calculation.position,
                        source: result.calculation.source,
                        is_verified: result.calculation.is_verified,
                        confidence: result.calculation.confidence || 0.7
                    };
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ö–æ–∂–∏—Ö –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞—Ö
                    if (result.similar_calibrations && result.similar_calibrations.length > 0) {
                        const similar = result.similar_calibrations;
                        showNotification(
                            `–î–ª—è –Ω–æ—Ç—ã ${note} –Ω–∞–π–¥–µ–Ω–æ ${similar.length} –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π`,
                            'info'
                        );
                    }
                    
                    updatePositionsBuilder();
                    showNotification(
                        `–†–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –ø–æ–∑–∏—Ü–∏—è –¥–ª—è ${note}: ${result.calculation.position}–º–º ` +
                        `(${result.calculation.source === 'calibrated' ? '–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ' : '—Ä–∞—Å—á–µ—Ç'})`,
                        'success'
                    );
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }
        
        // ========== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† ==========
        function updatePreview() {
            const container = document.getElementById('preview-table');
            container.innerHTML = '';
            
            selectedNotes.forEach((note, index) => {
                const isSpecial = specialNotes.includes(note);
                const position = notePositions[note] || (calculatedPositions[note] ? calculatedPositions[note].position : '');
                const diameter = noteDiameters[note] || 8.0;
                const calculation = calculatedPositions[note];
                
                let status = '';
                let statusClass = '';
                let confidence = 0;
                
                if (notePositions[note]) {
                    status = '‚úÖ –†—É—á–Ω–æ–π';
                    statusClass = 'note-status-high';
                    confidence = 100;
                } else if (calculation) {
                    if (calculation.source === 'calibrated') {
                        status = '‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π';
                        statusClass = 'note-status-high';
                        confidence = calculation.confidence ? Math.round(calculation.confidence * 100) : 90;
                    } else {
                        status = 'üìê –†–∞—Å—á–µ—Ç–Ω—ã–π';
                        statusClass = calculation.confidence > 0.8 ? 'note-status-high' : 
                                     calculation.confidence > 0.5 ? 'note-status-medium' : 'note-status-low';
                        confidence = calculation.confidence ? Math.round(calculation.confidence * 100) : 70;
                    }
                } else {
                    status = '‚ö†Ô∏è –ù–µ –∑–∞–¥–∞–Ω';
                    statusClass = 'note-status-low';
                    confidence = 0;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${note}</strong> ${isSpecial ? 'üéµ' : ''}</td>
                    <td>${position ? `${position} –º–º` : '‚Äî'}</td>
                    <td>${diameter} –º–º</td>
                    <td class="${statusClass}">${status}</td>
                    <td>${confidence}%</td>
                `;
                container.appendChild(row);
            });
        }
        
        // ========== –§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–ï–î–ü–†–û–°–ú–û–¢–† ==========
        function updateFinalPreview() {
            const container = document.getElementById('final-preview');
            
            const name = document.getElementById('dudex-name').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            const length = document.getElementById('tube-length').value;
            const holes = selectedNotes.length;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const tube = selectedComponents.tube ? 
                componentsData.tubes.find(t => t.id === selectedComponents.tube) : null;
            const mouthpiece = selectedComponents.mouthpiece ? 
                componentsData.mouthpieces.find(m => m.id === selectedComponents.mouthpiece) : null;
            const bell = selectedComponents.bell ? 
                componentsData.bells.find(b => b.id === selectedComponents.bell) : null;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4 style="color: #2E7D32; margin-bottom: 15px;">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                            <span>–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                            <strong>${name}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                            <span>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</span>
                            <strong>${key}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                            <span>–õ–∞–¥:</span>
                            <strong>${getScaleName(scaleType)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                            <span>–î–ª–∏–Ω–∞:</span>
                            <strong>${length} –º–º</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                            <span>–û—Ç–≤–µ—Ä—Å—Ç–∏–π:</span>
                            <strong>${holes}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                            <span>–û–∫—Ç–∞–≤—ã:</span>
                            <strong>${selectedOctaves.join(', ')}</strong>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #2E7D32; margin-bottom: 15px;">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h4>
            `;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            if (tube) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                        <span>–¢—Ä—É–±–∫–∞:</span>
                        <strong>${tube.name}</strong>
                    </div>
                `;
            } else if (selectedComponents.tube === null) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                        <span>–¢—Ä—É–±–∫–∞:</span>
                        <strong>–ù–µ –≤—ã–±—Ä–∞–Ω–∞</strong>
                    </div>
                `;
            }
            
            if (mouthpiece) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                        <span>–ú—É–Ω–¥—à—Ç—É–∫:</span>
                        <strong>${mouthpiece.name}</strong>
                    </div>
                `;
            } else if (selectedComponents.mouthpiece === null) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                        <span>–ú—É–Ω–¥—à—Ç—É–∫:</span>
                        <strong>–ù–µ –≤—ã–±—Ä–∞–Ω</strong>
                    </div>
                `;
            }
            
            if (bell) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                        <span>–†–∞—Å—Ç—Ä—É–±:</span>
                        <strong>${bell.name}</strong>
                    </div>
                `;
            } else if (selectedComponents.bell === null) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6;">
                        <span>–†–∞—Å—Ç—Ä—É–±:</span>
                        <strong>–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞</strong>
                    </div>
                `;
            }
            
            html += `</div></div>`;
            
            if (Object.keys(notePositions).length > 0) {
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #2E7D32; margin-bottom: 15px;">–ü–æ–∑–∏—Ü–∏–∏ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π (${Object.keys(notePositions).length} –∏–∑ ${holes})</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                selectedNotes.forEach((note, index) => {
                    const isSpecial = specialNotes.includes(note);
                    const pos = notePositions[note] || (calculatedPositions[note] ? calculatedPositions[note].position : '‚Äî');
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #dee2e6;">
                            <span>${index + 1}. ${note} ${isSpecial ? 'üéµ' : ''}</span>
                            <span><strong>${pos} –º–º</strong></span>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            container.innerHTML = html;
        }
        
        function getScaleName(scaleType) {
            const names = {
                'major': '–ú–∞–∂–æ—Ä (Ionian)',
                'minor': '–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –º–∏–Ω–æ—Ä (Aeolian)',
                'harmonic_minor': '–ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä',
                'melodic_minor': '–ú–µ–ª–æ–¥–∏—á–µ—Å–∫–∏–π –º–∏–Ω–æ—Ä',
                'pentatonic_major': '–ú–∞–∂–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞',
                'pentatonic_minor': '–ú–∏–Ω–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞',
                'blues': '–ë–ª—é–∑–æ–≤–∞—è –≥–∞–º–º–∞',
                'dorian': '–î–æ—Ä–∏–π—Å–∫–∏–π –ª–∞–¥ (Dorian)',
                'phrygian': '–§—Ä–∏–≥–∏–π—Å–∫–∏–π –ª–∞–¥ (Phrygian)',
                'lydian': '–õ–∏–¥–∏–π—Å–∫–∏–π –ª–∞–¥ (Lydian)',
                'mixolydian': '–ú–∏–∫—Å–æ–ª–∏–¥–∏–π—Å–∫–∏–π –ª–∞–¥ (Mixolydian)',
                'locrian': '–õ–æ–∫—Ä–∏–π—Å–∫–∏–π –ª–∞–¥ (Locrian)',
                'custom': '–°–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π'
            };
            return names[scaleType] || scaleType;
        }
        
        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –î–£–î–ò–ö–°–ê ==========
        async function saveDudex() {
            const name = document.getElementById('dudex-name').value.trim();
            const key = document.getElementById('key').value;
            const scaleType = document.getElementById('scale-type').value;
            const length = parseInt(document.getElementById('tube-length').value);
            const holes = selectedNotes.length;
            
            if (!name) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥—É–¥–∏–∫—Å–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            if (!selectedComponents.tube) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä—É–±–∫—É');
                return;
            }
            if (!selectedComponents.mouthpiece) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–¥—à—Ç—É–∫');
                return;
            }
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            const tubeId = selectedComponents.tube;
            const mouthpieceId = selectedComponents.mouthpiece;
            const bellId = selectedComponents.bell !== null ? selectedComponents.bell : null;
            
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:', {
                tube: tubeId,
                mouthpiece: mouthpieceId,
                bell: bellId
            });
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ä—Å—Ç–∏—è
            const holesData = [];
            selectedNotes.forEach((note, index) => {
                let position = notePositions[note];
                let source = 'manual';
                let is_verified = false;
                
                if (!position && calculatedPositions[note]) {
                    position = calculatedPositions[note].position;
                    source = calculatedPositions[note].source;
                    is_verified = calculatedPositions[note].is_verified || false;
                }
                
                if (position) {
                    holesData.push({
                        id: index + 1,
                        note: note,
                        position: parseFloat(position),
                        diameter: noteDiameters[note] || 8.0,
                        angle: (index * 60) % 360,
                        is_calibrated: source === 'calibrated' || is_verified,
                        source: source
                    });
                }
            });
            
            const dudexData = {
                name: name,
                key: key,
                scale: scaleType,
                tube_length: length,
                hole_count: holes,
                mouthpiece_id: mouthpieceId,
                tube_id: tubeId,
                bell_id: bellId,
                custom_notes: JSON.stringify(selectedNotes),
                holes_data: JSON.stringify(holesData),
                is_verified: isVerified
            };
            
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', dudexData);
            
            try {
                const response = await fetch('/api/flutes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dudexData)
                });
                
                const result = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                
                if (response.ok) {
                    showNotification(`‚úÖ –î—É–¥–∏–∫—Å "${name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`, 'success');
                    resetEditor();
                    loadDudexes();
                } else {
                    showError(`–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                showError(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò ==========
        async function loadDudexes() {
            try {
                const response = await fetch('/api/flutes');
                const data = await response.json();
                
                document.getElementById('dudexes-loading').style.display = 'none';
                document.getElementById('dudexes-container').style.display = 'block';
                
                const tableBody = document.getElementById('dudexes-list');
                tableBody.innerHTML = '';
                
                if (data.flutes && data.flutes.length > 0) {
                    data.flutes.forEach(dudex => {
                        const statusBadge = dudex.is_verified 
                            ? '<span class="verified-badge">‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω</span>'
                            : '<span class="unverified-badge">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>${dudex.name}</strong>
                                <div style="font-size: 0.9em; color: #666;">
                                    ${new Date(dudex.created_at).toLocaleDateString('ru-RU')}
                                </div>
                            </td>
                            <td><strong style="font-size: 1.2em;">${dudex.key}</strong></td>
                            <td>${dudex.tube_length} –º–º</td>
                            <td>${dudex.hole_count || 6}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button onclick="showDudexCard(${dudex.id})" style="margin-right: 5px; padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üëÅÔ∏è
                                </button>
                                <button onclick="downloadTemplate(${dudex.id})" style="margin-right: 5px; padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üì•
                                </button>
                                <button onclick="deleteDudex(${dudex.id})" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <p style="margin-bottom: 20px; color: #666;">üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –¥—É–¥–∏–∫—Å–æ–≤</p>
                                <p>–ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –¥—É–¥–∏–∫—Å–∞ –≤—ã—à–µ!</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—É–¥–∏–∫—Å–æ–≤:', error);
                document.getElementById('dudexes-loading').innerHTML = 
                    '<p style="color: #d32f2f;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        }
        
        // ========== –ö–ê–†–¢–û–ß–ö–ê –î–£–î–ò–ö–°–ê ==========
        async function showDudexCard(id) {
            try {
                const response = await fetch(`/api/flutes/${id}`);
                const dudex = await response.json();
                
                if (!response.ok) {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥—É–¥–∏–∫—Å–∞', 'error');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
                const overlay = document.createElement('div');
                overlay.className = 'overlay';
                overlay.onclick = function() {
                    document.body.removeChild(overlay);
                    document.body.removeChild(card);
                };
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                const card = document.createElement('div');
                card.className = 'dudex-card';
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                let componentsInfo = '';
                if (dudex.tube) {
                    componentsInfo += `<p><strong>–¢—Ä—É–±–∫–∞:</strong> ${dudex.tube.name} (${getMaterialName(dudex.tube.material)}, ‚åÄ${dudex.tube.d_in}–º–º)</p>`;
                }
                if (dudex.mouthpiece) {
                    componentsInfo += `<p><strong>–ú—É–Ω–¥—à—Ç—É–∫:</strong> ${dudex.mouthpiece.name} (${dudex.mouthpiece.type})</p>`;
                }
                if (dudex.bell) {
                    componentsInfo += `<p><strong>–†–∞—Å—Ç—Ä—É–±:</strong> ${dudex.bell.name} (${dudex.bell.type})</p>`;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –Ω–æ—Ç—ã
                let notesInfo = '';
                if (dudex.holes && dudex.holes.length > 0) {
                    const notes = dudex.holes.map(h => h.note).join(', ');
                    notesInfo = `<p><strong>–ù–æ—Ç—ã:</strong> ${notes}</p>`;
                }
                
                card.innerHTML = `
                    <div class="dudex-card-header">
                        <h2>üé∑ ${dudex.name}</h2>
                        <button onclick="closeDudexCard()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">√ó</button>
                    </div>
                    <div class="dudex-card-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                                <p><strong>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</strong> ${dudex.key}</p>
                                <p><strong>–õ–∞–¥:</strong> ${getScaleName(dudex.scale)}</p>
                                <p><strong>–î–ª–∏–Ω–∞:</strong> ${dudex.tube_length} –º–º</p>
                                <p><strong>–û—Ç–≤–µ—Ä—Å—Ç–∏–π:</strong> ${dudex.hole_count}</p>
                                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${dudex.is_verified ? '‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω' : 'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫'}</p>
                                <p><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(dudex.created_at).toLocaleString('ru-RU')}</p>
                            </div>
                            <div>
                                <h3>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h3>
                                ${componentsInfo || '<p>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>'}
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h3>–ù–æ—Ç—ã</h3>
                            ${notesInfo || '<p>–ù–æ—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>'}
                        </div>
                        ${dudex.holes && dudex.holes.length > 0 ? `
                        <div style="margin-top: 20px;">
                            <h3>–ü–æ–∑–∏—Ü–∏–∏ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π</h3>
                            <table class="note-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>–ù–æ—Ç–∞</th>
                                        <th>–ü–æ–∑–∏—Ü–∏—è (–º–º)</th>
                                        <th>–î–∏–∞–º–µ—Ç—Ä (–º–º)</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dudex.holes.map(hole => `
                                        <tr>
                                            <td><strong>${hole.note}</strong></td>
                                            <td>${hole.position} –º–º</td>
                                            <td>${hole.diameter || 8.0} –º–º</td>
                                            <td>${hole.is_calibrated ? '‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ' : 'üìê –†–∞—Å—á–µ—Ç'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                    </div>
                    <div class="dudex-card-footer">
                        <button class="btn btn-secondary" onclick="closeDudexCard()">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <button class="btn btn-success" onclick="downloadTemplate(${id})">üì• –°–∫–∞—á–∞—Ç—å SVG</button>
                        ${dudex.is_verified ? '' : `
                        <button class="btn btn-primary" onclick="markAsVerified(${id})">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π</button>
                        `}
                        <button class="btn btn-danger" onclick="deleteDudex(${id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                document.body.appendChild(card);
                
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏: ${error.message}`, 'error');
            }
        }
        
        function closeDudexCard() {
            const overlay = document.querySelector('.overlay');
            const card = document.querySelector('.dudex-card');
            if (overlay) document.body.removeChild(overlay);
            if (card) document.body.removeChild(card);
        }
        
        async function markAsVerified(id) {
            try {
                const response = await fetch(`/api/flutes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_verified: true })
                });
                
                if (response.ok) {
                    showNotification('–î—É–¥–∏–∫—Å –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π', 'success');
                    closeDudexCard();
                    loadDudexes();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }
        
        function downloadTemplate(id) {
            window.open(`/api/flutes/${id}/template`, '_blank');
        }
        
        async function deleteDudex(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥—É–¥–∏–∫—Å?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/flutes/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('–î—É–¥–∏–∫—Å —É–¥–∞–ª–µ–Ω', 'success');
                    loadDudexes();
                    closeDudexCard();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }
        
        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function resetEditor() {
            document.getElementById('dudex-name').value = '–ú–æ–π –¥—É–¥–∏–∫—Å';
            document.getElementById('key').value = 'D';
            document.getElementById('scale-type').value = 'minor';
            document.getElementById('tube-length').value = '450';
            document.getElementById('hole-count').value = '6';
            document.getElementById('is-verified-checkbox').checked = false;
            
            selectedOctaves = [3, 4];
            specialNotes = [];
            allPossibleNotes = [];
            selectedNotes = [];
            notePositions = {};
            noteDiameters = {};
            calculatedPositions = {};
            isVerified = false;
            
            document.querySelectorAll('.octave-btn').forEach(btn => {
                btn.classList.toggle('active', [3, 4].includes(parseInt(btn.dataset.octave)));
            });
            
            selectedComponents = { mouthpiece: null, tube: null, bell: null };
            document.querySelectorAll('.component-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            
            generateAllPossibleNotes();
            updateSpecialNotesList();
            goToStep(1);
            showNotification('–†–µ–¥–∞–∫—Ç–æ—Ä —Å–±—Ä–æ—à–µ–Ω', 'info');
        }
        
        function clearEditor() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) {
                resetEditor();
            }
        }
        
        function refreshAllData() {
            loadComponents();
            loadDudexes();
            showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${getNotificationIcon(type)}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 3000);
            }, 3000);
        }
        
        function getNotificationIcon(type) {
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            return icons[type] || '‚ÑπÔ∏è';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('create-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>