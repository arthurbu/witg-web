<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WITG - Wind Instrument Template Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .content {
            padding: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #4CAF50;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2E7D32;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        th {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .verified-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .flute-details {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .flute-details span {
            margin-right: 15px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #e9ecef;
            margin-top: 30px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è */
        .create-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #e9ecef;
        }
        
        .create-form h2 {
            color: #2E7D32;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .component-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .component-card:hover {
            border-color: #4CAF50;
            transform: translateY(-3px);
        }
        
        .component-card.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .component-card h4 {
            color: #2E7D32;
            margin-bottom: 5px;
        }
        
        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ WITG - Wind Instrument Template Generator</h1>
            <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∞–º–æ–¥–µ–ª—å–Ω—ã—Ö —Ñ–ª–µ–π—Ç</p>
        </header>
        
        <div class="content">
            
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="actions">
                <button class="btn btn-primary" onclick="showCreateForm()">
                    ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ–ª–µ–π—Ç—É
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/manage-components'">
                    üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
                </button>
                <button class="btn btn-secondary" onclick="refreshData()">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–ª–µ–π—Ç—ã (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
            <div id="create-form" class="create-form" style="display: none;">
                <h2>üéµ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ–ª–µ–π—Ç—ã</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="flute-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–ª–µ–π—Ç—ã</label>
                        <input type="text" id="flute-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—è —Ñ–ª–µ–π—Ç–∞ –≤ D">
                    </div>
                    
                    <div class="form-group">
                        <label for="key">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label>
                        <select id="key">
                            <option value="C">C (–î–æ)</option>
                            <option value="D" selected>D (–†–µ)</option>
                            <option value="E">E (–ú–∏)</option>
                            <option value="F">F (–§–∞)</option>
                            <option value="G">G (–°–æ–ª—å)</option>
                            <option value="A">A (–õ—è)</option>
                            <option value="B">B (–°–∏)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tube-length">–î–ª–∏–Ω–∞ —Ç—Ä—É–±–∫–∏ (–º–º)</label>
                        <input type="number" id="tube-length" value="450" min="200" max="800" step="10">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="hole-count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ä—Å—Ç–∏–π</label>
                        <select id="hole-count">
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6" selected>6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–ú—É–Ω–¥—à—Ç—É–∫</label>
                        <div class="components-grid" id="mouthpieces-cards">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>–¢—Ä—É–±–∫–∞</label>
                        <div class="components-grid" id="tubes-cards">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>–†–∞—Å—Ç—Ä—É–±</label>
                        <div class="components-grid" id="bells-cards">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                    </div>
                </div>
                
                <div id="create-error" class="error"></div>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="hideCreateForm()">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                    <button class="btn btn-primary" onclick="createFlute()">
                        ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ñ–ª–µ–π—Ç—É
                    </button>
                    <button class="btn btn-primary" onclick="createAndCalculate()">
                        üîÑ –°–æ–∑–¥–∞—Ç—å —Å —Ä–∞—Å—á–µ—Ç–æ–º
                    </button>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —Ñ–ª–µ–π—Ç -->
            <h2>üé∂ –ú–æ–∏ —Ñ–ª–µ–π—Ç—ã</h2>
            <div class="loading" id="flutes-loading">
                –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–ª–µ–π—Ç...
            </div>
            <div id="flutes-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</th>
                            <th>–î–ª–∏–Ω–∞</th>
                            <th>–û—Ç–≤–µ—Ä—Å—Ç–∏–π</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="flutes-list">
                        <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            <p>WITG v1.0 | Wind Instrument Template Generator | 2024</p>
            <p>–°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—á–µ—Ç–∞ –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∞–º–æ–¥–µ–ª—å–Ω—ã—Ö –¥—É—Ö–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</p>
        </footer>
    </div>
    
    <script>
        // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        let selectedComponents = {
            mouthpiece: null,
            tube: null,
            bell: null
        };
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadFlutes();
            loadComponents(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º—ã
        });
        
       
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–ª–µ–π—Ç
        async function loadFlutes() {
            try {
                const response = await fetch('/api/flutes');
                const data = await response.json();
                
                document.getElementById('flutes-loading').style.display = 'none';
                document.getElementById('flutes-table').style.display = 'block';
                
                const tableBody = document.getElementById('flutes-list');
                tableBody.innerHTML = '';
                
                if (data.flutes && data.flutes.length > 0) {
                    data.flutes.forEach(flute => {
                        const row = document.createElement('tr');
                        
                        const statusBadge = flute.is_verified 
                            ? '<span class="verified-badge">‚úì –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞</span>'
                            : '<span style="color: #666;">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>';
                        
                        row.innerHTML = `
                            <td>
                                <strong>${flute.name}</strong>
                                <div class="flute-details">
                                    <span>–°–æ–∑–¥–∞–Ω–∞: ${new Date(flute.created_at).toLocaleDateString('ru-RU')}</span>
                                </div>
                            </td>
                            <td><strong style="font-size: 1.2em;">${flute.key}</strong></td>
                            <td>${flute.tube_length} –º–º</td>
                            <td>${flute.hole_count || 6}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button onclick="viewFlute(${flute.id})" style="margin-right: 5px; padding: 5px 10px;">üëÅÔ∏è</button>
                                <button onclick="downloadTemplate(${flute.id})" style="padding: 5px 10px;">üì•</button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <p style="margin-bottom: 20px;">üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–ª–µ–π—Ç</p>
                                <button class="btn btn-primary" onclick="showCreateForm()">
                                    ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Ñ–ª–µ–π—Ç—É
                                </button>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–ª–µ–π—Ç:', error);
                document.getElementById('flutes-loading').innerHTML = 
                    '<p style="color: #d32f2f;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è —Ñ–æ—Ä–º—ã
        async function loadComponents() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º—É–Ω–¥—à—Ç—É–∫–∏
                const mpRes = await fetch('/api/mouthpieces');
                const mpData = await mpRes.json();
                renderComponents('mouthpieces', mpData.mouthpieces || []);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä—É–±–∫–∏
                const tubesRes = await fetch('/api/tubes');
                const tubesData = await tubesRes.json();
                renderComponents('tubes', tubesData.tubes || []);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ç—Ä—É–±—ã
                const bellsRes = await fetch('/api/bells');
                const bellsData = await bellsRes.json();
                renderComponents('bells', bellsData.bells || []);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:', error);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        function renderComponents(type, components) {
            const container = document.getElementById(`${type}-cards`);
            container.innerHTML = '';
            
            // –î–ª—è —Ä–∞—Å—Ç—Ä—É–±–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞"
            if (type === 'bells') {
                const noneCard = createComponentCard(null, type, '–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞', '–ü—Ä—è–º–∞—è —Ç—Ä—É–±–∫–∞');
                container.appendChild(noneCard);
            }
            
            // –î–ª—è –º—É–Ω–¥—à—Ç—É–∫–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ë–µ–∑ –º—É–Ω–¥—à—Ç—É–∫–∞"
            if (type === 'mouthpieces') {
                const noneCard = createComponentCard(null, type, '–ë–µ–∑ –º—É–Ω–¥—à—Ç—É–∫–∞', '–ù–∞—Ç–∏–≤–Ω–∞—è —Ñ–ª–µ–π—Ç–∞');
                container.appendChild(noneCard);
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            components.forEach(component => {
                const title = component.name;
                let subtitle = '';
                
                if (type === 'mouthpieces') {
                    subtitle = `–î–∏–∞–º–µ—Ç—Ä: ${component.inner_diameter || '?'}–º–º`;
                } else if (type === 'tubes') {
                    subtitle = `–î–∏–∞–º–µ—Ç—Ä: ${component.inner_diameter}–º–º`;
                    if (component.material) subtitle += ` | ${component.material}`;
                } else if (type === 'bells') {
                    subtitle = component.type === 'none' ? '–ë–µ–∑ —Ä–∞—Å—Ç—Ä—É–±–∞' : `–¢–∏–ø: ${component.type}`;
                }
                
                const card = createComponentCard(component.id, type, title, subtitle);
                container.appendChild(card);
            });
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        function createComponentCard(id, type, title, subtitle) {
            const card = document.createElement('div');
            card.className = 'component-card';
            card.dataset.id = id;
            card.dataset.type = type;
            
            card.innerHTML = `
                <h4>${title}</h4>
                <p>${subtitle}</p>
            `;
            
            card.addEventListener('click', () => selectComponent(id, type));
            
            return card;
        }
        
        // –í—ã–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        function selectComponent(id, type) {
            selectedComponents[type] = id;
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
            const allCards = document.querySelectorAll(`.component-card[data-type="${type}"]`);
            allCards.forEach(card => card.classList.remove('selected'));
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            const selectedCard = document.querySelector(`.component-card[data-type="${type}"][data-id="${id}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è
        function showCreateForm() {
            document.getElementById('create-form').style.display = 'block';
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
            document.getElementById('create-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è
        function hideCreateForm() {
            document.getElementById('create-form').style.display = 'none';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('flute-name').value = '';
            document.getElementById('key').value = 'D';
            document.getElementById('tube-length').value = '450';
            document.getElementById('hole-count').value = '6';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            selectedComponents = { mouthpiece: null, tube: null, bell: null };
            document.querySelectorAll('.component-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.getElementById('create-error').style.display = 'none';
        }
        
        // –°–æ–∑–¥–∞—Ç—å —Ñ–ª–µ–π—Ç—É
        async function createFlute() {
            const name = document.getElementById('flute-name').value.trim();
            const key = document.getElementById('key').value;
            const length = document.getElementById('tube-length').value;
            const holes = document.getElementById('hole-count').value;
            
            // –î–ï–ë–ê–ì: –ø–æ—Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ
            console.log('–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç—Ä—É–±–∫–∞:', selectedComponents.tube);
            console.log('–í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:', selectedComponents);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!name) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–ª–µ–π—Ç—ã');
                return;
            }
            
            if (!selectedComponents.tube) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä—É–±–∫—É');
                return;
            }
            
            const fluteData = {
                name: name,
                key: key,
                tube_length: parseInt(length),
                hole_count: parseInt(holes),
                mouthpiece_id: selectedComponents.mouthpiece,
                tube_id: selectedComponents.tube,
                bell_id: selectedComponents.bell
            };
            
            try {
                const response = await fetch('/api/flutes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fluteData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ –§–ª–µ–π—Ç–∞ "${name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
                    hideCreateForm();
                    refreshData(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    showError(`–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                showError(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å —Å —Ä–∞—Å—á–µ—Ç–æ–º –æ—Ç–≤–µ—Ä—Å—Ç–∏–π
        async function createAndCalculate() {
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
            const length = document.getElementById('tube-length').value;
            const key = document.getElementById('key').value;
            const holes = document.getElementById('hole-count').value;
            
            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tube_length: parseInt(length),
                        key: key,
                        hole_count: parseInt(holes)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º —Ñ–ª–µ–π—Ç—É —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ä—Å—Ç–∏—è–º–∏
                    await createFlute();
                } else {
                    showError(`–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                showError(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorDiv = document.getElementById('create-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // –î—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function refreshData() {
            document.getElementById('flutes-loading').style.display = 'block';
            document.getElementById('flutes-table').style.display = 'none';
            loadFlutes();
        }
        
        function viewFlute(id) {
            window.location.href = `/flute/${id}`;
        }
        
        function downloadTemplate(id) {
            window.open(`/api/flutes/${id}/template`, '_blank');
        }
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadStats, 30000);
    </script>
</body>
</html>